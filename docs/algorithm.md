This document exists to offer a plain-English explanation of how Peter works. Peter is based heavily on SCRIBE, but there is no guarantee that Peter does not stray from the SCRIBE paper. This document is the only canon spec for how Peter functions.

## Wendy

Peter uses [Wendy](https://github.com/secondbit/wendy) as its organisation and communication layer. Peter nodes are simply Wendy nodes with special behaviour. Please consult Wendy's documentation for information on the algorithm, its premises, and the guarantees it does and does not make.

## Topics

Each topic is simply a string. The string is then used to compute a message ID in Wendy; this means that only the first 32 bytes of the topic will be used. Topics whose first 32 bytes collide will be treated as the same topic, even if their subsequent bytes are different.

Topics are what are published and subscribed to. A node expresses its interest in a topic, then receives updates when other nodes publish to that topic.

## Subscribing to a Topic

Subscribing to a topic is achieved by routing a special subscribe message towards the message ID generated by the topic.

As each node receives the message, it prematurely terminates it. Each node is the "parent" in the subscription tree to the previous node that sent the message. So if node A sends to node B sends to node C, B is the parent to A, and C is the parent to B.

Upon receiving the message, if the current node already has "children" interested in the topic, the node adds the new child to the list of interested children, and that's the end of the subscription.

If the current node has no children interested in the topic, it adds the new child to the list of interested children, creates a new message with the same ID, and forwards it on. The next node in the path will add the current node as a child, and repeat the process. This builds a resilient tree of subscriptions rooted at the "meeting point", the node closest in ID to the topic ID.

When a node is observed to have left the cluster, the subscription tree repairs itself. The nodes that knew about the departed node check to see whether or not the departed node was a parent in the subscription tree for one or more of their topics. If it was, they rebroadcast the subscribe message, repairing the subscription tree.

When a node is observed to have joined the cluster, the subscription tree must repair itself, lest the new node change the meeting place for a topic. To do so, when a node joins the cluster, nodes that are notified of its entry loop through the topics they know about, and route against the topic ID. If the returned node is the joined node, the nodes unsubscribe from the topic, then resubscribe, repairing the subscription tree.

## Unsubscribing from a Topic

Unsubscribing from a topic is achieved by routing a special unsubscribe message towards the message ID generated by the topic.

Each node that receives the unsubscribe message prematurely terminates it and removes the node they received it from from their map of children. If their map of children is now empty, the node duplicates the message and sends it on to the next node, as it's no longer interested in the topic.

## Publishing to a Topic

Publishing to a topic is achieved by routing a special publish message towards the message ID generated by the topic.

The message is routed until it reaches its destination, the meeting point. The meeting point then duplicates the message to each of its children that are interested in the topic. They, in turn, duplicate to every interested child. This duplication is continued until every interested node is notified of the message.